{
    "contents" : "#Vellore environmental sample data;\nsetwd(\"~/stat/CMC/data/exposure data/\")\nre_dr<-read.csv(\"Drain_Sample_Database_092214_with_ec_conc.csv\",header=TRUE)\nhh_dat<-read.csv(\"Ind_data_102715.csv\",header=TRUE)\npd_dat<-read.csv(\"phase2 public domain samples.csv\",header=TRUE)\n\nlibrary(dplyr)\ndat1<-re_dr %>% \n  select(SampleID,HouseID,ev_lat,ev_long,neighbor,ec_conc) %>% \n  mutate(study=\"re\",SampleType=\"Drain\")\ndat2<-hh_dat %>% \n  select(SampleID,HouseID,ev_lat,ev_long,neighbor,SampleType,ec_conc) %>% \n  mutate(study=\"hh\")\ndat3<-pd_dat %>% \n  select(sample_name,GPS_latitude,GPS_longitude,neighborhood,sample_type_name,ec_conc) %>% \n  mutate(study=\"hh\",HouseID=\"NA\") %>% \n  rename(SampleID=sample_name,ev_lat=GPS_latitude,ev_long=GPS_longitude,neighbor=neighborhood,SampleType=sample_type_name)\n#remove duplicated samples\ndat3<-dat3[which(!duplicated(dat3[,1:6])),]\n\ndat_all0<-rbind(dat1,dat2,dat3)\ndat_all<-dat_all0[which(!is.na(dat_all0$ec_conc) & dat_all0$ev_long>=78 & dat_all0$ev_long<=79.16 & dat_all0$ev_lat>=12.8),]\ndat_all$ec_lnconc<-log10(dat_all$ec_conc)\n#replace log10(0) to a small value (-3);\ndat_all$ec_lnconc[which(dat_all$ec_conc==0)]<--3\n\n#Old Town = 1, Cinna Allapuram = 2;\ndat_all$neighbor[which(dat_all$neighbor==\"Old Town\")]<-\"1\"\ndat_all$neighbor[which(dat_all$neighbor==\"Cinna Allapuram\")]<-\"2\"\n\ndat_all<-dat_all[which(dat_all$neighbor==\"1\"),]\n\n########################################################################################\n#Vellore Health outcome data\nsetwd(\"~/stat/CMC/data\")\ncmc<-read.csv(\"data_cmc.csv\",header=TRUE)\ncmc$sample_date<-as.Date(as.character(cmc$sdate),\"%m/%d/%y\")\n\n#####################################################\ncmc<-cmc[c(1:3752),]\ncmc$last=0\ncount=0\nfor (i in 1:(length(cmc$IDNO)-1)){\n  if (cmc$IDNO[i]==cmc$IDNO[i+1] & cmc$stooltype[i]==\"D1\"){\n    count=count+1;\n    cmc$n_illness[i]=count;\n  }\n  if (cmc$IDNO[i]!=cmc$IDNO[i+1] & cmc$stooltype[i]==\"D1\"){\n    cmc$last[i]=1;\n    count=count+1;\n    cmc$n_illness[i]=count;\n    count=0;\n  }\n  if (cmc$IDNO[i]==cmc$IDNO[i+1] & cmc$stooltype[i]==\"M1\"){\n    cmc$n_illness[i]=count;\n  }\n  if (cmc$IDNO[i]!=cmc$IDNO[i+1] & cmc$stooltype[i]==\"M1\"){\n    cmc$last[i]=1;\n    cmc$n_illness[i]=count;\n    count=0;\n  }  \n}\n#hard code the last line;\ncmc$last[length(cmc$last)]=1;\ncmc$n_illness[length(cmc$last)]<-1;\n\ncmc$bact<-cmc$bacteria\ncmc$bact[which(cmc$stooltype==\"D1\")]=0\ncmc$vir<-cmc$virus\ncmc$vir[which(cmc$stooltype==\"D1\")]=0\ncmc$test<-1\nlibrary(plyr)\nn_pos_bact <- ddply ( cmc, .(cmc$IDNO), function(x) cumsum(x[55]))[,2]\nn_pos_virus <- ddply ( cmc, .(cmc$IDNO), function(x) cumsum(x[56]))[,2]\nn_test <- ddply ( cmc, .(cmc$IDNO), function(x) cumsum(x[57]))[,2]\ncmc$n_pos_bact<-n_pos_bact\ncmc$n_pos_virus<-n_pos_virus\ncmc$n_test<-n_test\n\ncmc_clu0<-cmc[which(cmc$last==1),]\n\nstart_date<-aggregate(sample_date ~ IDNO, cmc, function(x) min(x))\nend_date<-aggregate(sample_date ~ IDNO, cmc, function(x) max(x))\nstudy_date<-merge(start_date,end_date,by=\"IDNO\")\ncolnames(study_date)[2:3]<-c(\"start_date\",\"end_date\")\nstudy_date$duration<-study_date$end_date-study_date$start_date+1\ncmc_clu<-merge(cmc_clu0,study_date)\n\n#link each child with the closest environmental samples\n# Calculates the geodesic distance between two points specified by radian latitude/longitude using the\n# Haversine formula (hf)\ngcd.hf <- function(long1, lat1, long2, lat2) {\n  R <- 6371 # Earth mean radius [km]\n  delta.long <- (long2 - long1)\n  delta.lat <- (lat2 - lat1)\n  a <- sin(delta.lat/2)^2 + cos(lat1) * cos(lat2) * sin(delta.long/2)^2\n  c <- 2 * asin(min(1,sqrt(a)))\n  d = R * c\n  return(d) # Distance in km\n}\n\nsamtype<-c(\"Bathing Water\", \"Child Hand Rinse\", \"Drain\", \"Particulate\", \"Piped Water\", \"Produce\", \"Swabs\", \"Toy Feeding Spoon Rinse\")\n\ndistance<-list()\nsampleID<-list()\nec_lnconc<-list()\nfor (s in 1:length(samtype)){\n  sp_dat<-dat_all[which(dat_all$SampleType==samtype[s]),]\n  can<-array(NA,dim=c(length(cmc_clu$IDNO),length(sp_dat$SampleID)))\n  id<-array(NA,dim=c(length(cmc_clu$IDNO),length(sp_dat$SampleID)))\n  conc<-array(NA,dim=c(length(cmc_clu$IDNO),length(sp_dat$SampleID)))\n  for (i in 1:length(cmc_clu$IDNO)){\n    for (j in 1:length(sp_dat$SampleID)){\n      can[i,j]<-gcd.hf(cmc_clu$LON[i],cmc_clu$LAT[i],sp_dat$ev_long[j],sp_dat$ev_lat[j])\n      id[i,j]<-levels(sp_dat$SampleID)[sp_dat$SampleID[j]]\n      conc[i,j]<-sp_dat$ec_lnconc[j]\n    }\n  }\n  distance[[s]]<-can\n  sampleID[[s]]<-id\n  ec_lnconc[[s]]<-conc\n}\n\n#sampleID[[1]][1,which(distance[[1]][1,]==min(distance[[1]][1,]))]\n#distance[[1]][1,which(distance[[1]][1,]==min(distance[[1]][1,]))]\n#ec_lnconc[[1]][1,which(distance[[1]][1,]==min(distance[[1]][1,]))]\n\ndat0<-cmc_clu[,c(2,5,6,7,12,16,54,58,59,60,61,62,63)]\nfor(x in (length(dat0[1,])+1):(length(dat0[1,])+24)){\n  dat0[,x] <- NA\n}\ncolnames(dat0)<-c(\"IDNO\",\"LAT\",\"LON\",\"ALTITUDE\",\"sanipath_pid\",\"neighborhood\",\"n_illness\",\n                  \"n_pos_bact\",\"n_pos_virus\",\"n_test\",\"start_date\",\"end_date\",\"duration\",\n                  \"Bath_ID\",\"Bath_Dis\",\"Bath_lnconc\",\"CHR_ID\",\"CHR_Dis\",\"CHR_lnconc\",\n                  \"Drain_ID\",\"Drain_Dis\",\"Drain_lnconc\",\"Part_ID\",\"Part_Dis\",\"Part_lnconc\",\n                  \"Piped_ID\",\"Piped_Dis\",\"Piped_lnconc\",\"Pro_ID\",\"Pro_Dis\",\"Pro_lnconc\",\n                  \"Swab_ID\",\"Swab_Dis\",\"Swab_lnconc\",\"TFSR_ID\",\"TFSR_Dis\",\"TFSR_lnconc\")\n\nfor (s in 1:length(samtype)){\n  for (i in 1:length(cmc_clu$IDNO)){\n    dat0[i,3*(s-1)+length(dat0[1,])-23]<-paste0(sampleID[[s]][i,which(distance[[s]][i,]==min(distance[[s]][i,]))],collapse = ',')\n    dat0[i,3*(s-1)+length(dat0[1,])-22]<-min(distance[[s]][i,which(distance[[s]][i,]==min(distance[[s]][i,]))])\n    dat0[i,3*(s-1)+length(dat0[1,])-21]<-mean(ec_lnconc[[s]][i,which(distance[[s]][i,]==min(distance[[s]][i,]))],na.rm=TRUE)\n  }\n}\n",
    "created" : 1469636664448.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3507179712",
    "id" : "8EF60276",
    "lastKnownWriteTime" : 1470149506,
    "path" : "~/stat/CMC/v4/v4.data.R",
    "project_path" : "v4.data.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}